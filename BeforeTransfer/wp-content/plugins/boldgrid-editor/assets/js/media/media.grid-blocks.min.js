var IMHWPB=IMHWPB||{};IMHWPB.Media=IMHWPB.Media||{},function(t){IMHWPB.Media.GridBlocks={init:function(){this.fetch_api_gridblocks()},strip_uneeded_markup:function(i){return t.each(["html","preview-html"],function(){var a=t(i[this]);a.find("img").removeClass(function(t,i){return(i.match(/(^|\s)wp-image-\S+/g)||[]).join(" ")}).each(function(){var i=t(this);i.parent().is("a")&&i.unwrap()}),i[this+"-jquery"]=a,i[this]=a.wrapAll("<div>").parent().html()}),i},remove_duplicate_gridblocks:function(i){var a=t(i.html);a.find("img").removeAttr("src class"),a.find("a").removeAttr("href"),i.generalized_markup=a.wrapAll("<div>").parent().html(),i.generalized_markup=i.generalized_markup.replace(/ /g,"");var e=!0;return t.each(IMHWPB.Globals.tabs["basic-gridblocks"].content,function(t,a){i.generalized_markup==a.generalized_markup&&(e=!1)}),e||(i=null),i},fetch_api_gridblocks:function(){var i=this,a=t("#media-upload"),e={action:"boldgrid_gridblock_html",boldgrid_gridblock_image_html_nonce:IMHWPB.Globals.grid_block_html_nonce,post_id:IMHWPB.Globals.post_id};a.addClass("loading-gridblocks");var r=function(t){a.removeClass("loading-gridblocks")},d=function(a){var e=t('.attachments[data-tabname="basic-gridblocks"]'),r=wp.template("gridblock-attachment"),d=[],n=IMHWPB.Globals.tabs["basic-gridblocks"].content;a.success&&a.gridblocks&&t.each(a.gridblocks,function(){var a=this;if(a=i.strip_uneeded_markup(a),a=i.remove_duplicate_gridblocks(a)){n.push(a);var e=r(a),o=t(e),l=n.length-1;o.attr("data-id",l),d.push(o[0].outerHTML)}}),e.append(d.join(" ")),IMHWPB.ExistingLayouts.filter_out_nested_hr()};t.ajax({url:ajaxurl,dataType:"json",data:e,method:"POST"}).always(r).done(d)},format_dynamic_image_data:function(i){var a=[];return i&&i.build_profile_id&&i["html-jquery"].find("img").each(function(){var i=t(this),e=i.attr("data-imhwpb-built-photo-search"),r=i.attr("data-image-provider-id"),d=i.attr("data-id-from-provider");if(e&&!this.boldgrid_updated_src){var n=Math.random().toString().replace("0.","").substring(0,8),o={post_id:IMHWPB.Globals.post_id,id_from_provider:d,image_provider_id:r,rand_image_id:n};this.boldgrid_rand_image_id=n,a.push(o)}}),a},remove_attribution_attributes:function(t){t.removeAttr("data-boldgrid-asset-id").removeAttr("data-pending-boldgrid-attribution")},swap_image_with_placeholder:function(t){var i=t.attr("width")?t.attr("width"):"300",a=t.attr("height")?t.attr("height"):"300";t.attr("src","//placehold.it/"+i+"x"+a+"/cccccc/")},validateImageTags:function(i){var a=this,e=t("<div>").html(i);return e.find("img").each(function(){var i=t(this);i.attr("src")||a.swap_image_with_placeholder(i)}),e.html()},get_selected_html:function(){var i=this,a="";return t('.attachment[aria-checked="true"]').each(function(){var e=t(this),r=e.find(".centered-content-boldgrid"),d=null,n=e.attr("data-id");IMHWPB.Globals.tabs["basic-gridblocks"].content[n]&&(d=IMHWPB.Globals.tabs["basic-gridblocks"].content[n]);var o=[];r.find("[data-pending-boldgrid-attribution]").each(function(){o.push(t(this).data("boldgrid-asset-id"))});var l=i.format_dynamic_image_data(d);if(o.length||l.length){var s=t.Deferred(),c={action:"boldgrid_gridblock_image",boldgrid_asset_ids:JSON.stringify(o),boldgrid_gridblock_image_ajax_nonce:IMHWPB.Globals.grid_block_nonce,dynamic_images:l},h=function(){r.find("[data-pending-boldgrid-attribution]").each(function(){var a=t(this);i.swap_image_with_placeholder(a),i.remove_attribution_attributes(a)}),d&&d.build_profile_id&&d["html-jquery"].find("img[data-imhwpb-built-photo-search]").each(function(){var a=t(this);this.boldgrid_updated_src||i.swap_image_with_placeholder(a)})},_=function(t,i){t.attr("src",i.url),"undefined"!=typeof i.attachment_id&&i.attachment_id&&t.attr("class","wp-image-"+i.attachment_id)},u=function(a,e){t.each(a,function(){if(this.asset_id&&this.url){var t=r.find('[data-boldgrid-asset-id="'+this.asset_id+'"]');_(t,this),i.remove_attribution_attributes(t)}}),d&&d.build_profile_id&&t.each(e,function(i,a){this.rand_image_id&&this.url&&d["html-jquery"].find("img[data-imhwpb-built-photo-search]").each(function(){if(a.rand_image_id==this.boldgrid_rand_image_id){var i=t(this);this.boldgrid_updated_src=!0,_(i,a)}})}),h()},g=function(t){t.success&&u(t.asset_ids,t.dynamic_images)},m=function(i){u([],[]),t(".boldgrid-loading-graphic-wrapper").fadeOut(),d.api_insert?s.resolve(d["html-jquery"].wrapAll("<div>").parent().html()):s.resolve(e.find(".centered-content-boldgrid").html()),parent.IMHWPB.Media.instance.toggle_insert_button(!0)};t(".boldgrid-loading-graphic-wrapper").fadeIn(),parent.IMHWPB.Media.instance.toggle_insert_button(!1),t.ajax({url:ajaxurl,dataType:"json",data:c,method:"POST",timeout:15e3}).success(g).always(m),a=s}else a=d.html,d&&d["html-jquery"]?a=d["html-jquery"].wrapAll("<div>").parent().html():a||(a=e.find(".centered-content-boldgrid").html()),a=i.validateImageTags(a);return!1}),a}},t(function(){IMHWPB.Media.GridBlocks.init()})}(jQuery);