var BOLDGRID=BOLDGRID||{};BOLDGRID.EDITOR=BOLDGRID.EDITOR||{},BOLDGRID.EDITOR.Crop=function(t){var e=this;e.modal,e.selectedCoordinates=null,e.newImage=!1,e.oldImage=!1,this.modalClear=function(){e.$mediaModal.css("display","block"),e.$modalContent.empty(),e.$modalToolbar.empty();var t=wp.template("suggest-crop-compare");e.$modalContent.html(t())},this.crop=function(){e.$skipButton.prop("disabled",!0),e.$primaryButton.prop("disabled",!0).text("Cropping...");var i={action:"suggest_crop_crop",cropDetails:e.selectedCoordinates,path:e.$selectDimensions.find("option:selected").val(),originalWidth:t(e.oldImage)[0].naturalWidth,originalHeight:t(e.oldImage)[0].naturalHeight,id:e.$selectDimensions.attr("data-id")};t.post(ajaxurl,i,function(t){e.cropValidate(t)})},this.cropInvalid=function(){var i=wp.template("suggest-crop-invalid");e.$modalToolbar.html(i()),t("button.crop-fail").on("click",function(){e.modal.close()})},this.cropValidate=function(i){if("0"===i)return void e.cropInvalid();try{i=JSON.parse(i)}catch(o){return void e.cropInvalid()}var a=!0,n=["new_image_height","new_image_width","new_image_url"];t.each(n,function(t,e){if(void 0===i[e])return a=!1,!1}),a?e.cropValid(i):e.cropInvalid()},this.cropValid=function(i){var o=tinyMCE.activeEditor.selection.getNode();o.src=i.new_image_url,o.width=i.new_image_width,o.height=i.new_image_height,o.setAttribute("data-mce-src",i.new_image_url),e.$skipButton.prop("disabled",!1),e.$primaryButton.prop("disabled",!1).text(t(this).attr("data-default-text")),e.modal.close()},this.setImages=function(i){var o=new Image,a=new Image,n=wp.template("suggest-crop-sizes"),d={action:"suggest_crop_get_dimensions",attachment_id:i.attachment_id,originalWidth:i.customWidth,originalHeight:i.customHeight};jQuery.post(ajaxurl,d,function(d){if("0"===d)return e.modal.close(),!1;try{d=JSON.parse(d)}catch(s){return e.modal.close(),!1}e.$selectDimensions=t(n(d)),e.$selectDimensions.attr("data-id",i.attachment_id),o.onload=function(){e.oldImage=o,e.selectBestFit(),a.onload=function(){e.newImage=a,e.compareImages()},a.src=e.bestSizeSelector},o.src=i.originalUrl})},this.selectBestFit=function(){var i,o=parseFloat(e.oldImage.width/e.oldImage.height);i=o<1?e.$selectDimensions.find("option").filter(function(){return t(this).attr("data-height")>=e.oldImage.height}):e.$selectDimensions.find("option").filter(function(){return t(this).attr("data-width")>=e.oldImage.width}),1===i.length?e.bestSizeSelector=i.eq(0).val():0===i.length?e.bestSizeSelector=e.$selectDimensions.find("option").last().val():e.bestSizeSelector=i.eq(1).val(),e.$selectDimensions.find('option[value="'+e.bestSizeSelector+'"]').prop("selected",!0)},this.selectCoordinates=function(){e.setDefaultCoordinates(e.oldImage.width,e.oldImage.height,e.newImage.width,e.newImage.height),e.ias=e.$suggestCrop.imgAreaSelect({aspectRatio:e.defaultCoordinates.aspectRatio,handles:!0,imageHeight:e.newImage.height,imageWidth:e.newImage.width,instance:!0,keys:!0,persistent:!0,parent:e.$modalContent.find(".container-crop .left"),x1:e.defaultCoordinates.x1,y1:e.defaultCoordinates.y1,x2:e.defaultCoordinates.x2,y2:e.defaultCoordinates.y2,onInit:function(t,i){e.setSelectedCoordinates(t,i)},onSelectEnd:function(t,i){e.setSelectedCoordinates(t,i)}})},this.init=function(){},this.onReplace=function(t){e.modalOpen(),e.setImages(t)},this.onResize=function(){e.$modalContent.is(":visible")&&e.ias.setOptions({imageHeight:e.newImage.naturalHeight,imageWidth:e.newImage.naturalWidth,x1:e.selectedCoordinates.x1,y1:e.selectedCoordinates.y1,x2:e.selectedCoordinates.x2,y2:e.selectedCoordinates.y2})},this.onSize=function(i){var o;e.$suggestCrop.off("load").attr("src",i).on("load",function(){o=t(this)[0],img1Width=e.oldImage.width,img1Height=e.oldImage.height,img2Width=o.naturalWidth,img2Height=o.naturalHeight,e.setDefaultCoordinates(img1Width,img1Height,img2Width,img2Height),e.ias.setOptions({aspectRatio:e.defaultCoordinates.aspectRatio,imageHeight:o.naturalHeight,imageWidth:o.naturalWidth,x1:e.defaultCoordinates.x1,y1:e.defaultCoordinates.y1,x2:e.defaultCoordinates.x2,y2:e.defaultCoordinates.y2}),e.setSelectedCoordinates(null,{height:o.naturalHeight,width:o.naturalWidth,x1:e.defaultCoordinates.x1,y1:e.defaultCoordinates.y1,x2:e.defaultCoordinates.x2,y2:e.defaultCoordinates.y2}),e.$modalContent.find('[name="force-aspect-ratio"]').prop("checked",!0)})},this.modalCreate=function(){e.modal=wp.media({id:"crop",title:"Crop Image",button:{text:"Crop Image"}}),e.modal.open(),e.$mediaModal=t(".media-modal").last(),e.$modalContent=e.$mediaModal.find(".media-frame-content",".media-modal"),e.$modalToolbar=e.$mediaModal.find(".media-frame-toolbar",".media-modal"),t(window).resize(function(){e.onResize()})},this.modalOpen=function(){return e.modal?(e.modal.open(),void e.modalClear()):(e.modalCreate(),void e.modalClear())},this.onMatch=function(){var t=wp.template("suggest-crop-match");e.$modalContent.html(t()),setTimeout(function(){e.$mediaModal.fadeOut("1000",function(){e.modal.close()})},1e3)},this.modalFill=function(){var i={oldImageSrc:e.oldImage.src,newImageSrc:e.newImage.src,newContentSrc:e.bestSizeSelector},o=wp.template("suggest-crop");e.$modalContent.html(o(i)),e.$suggestCrop=e.$modalContent.find(".suggest-crop"),t(".imgedit-group.imgedit-source p").last().html(e.$selectDimensions),e.$selectDimensions.on("change",function(){var i=t(this).val();e.onSize(i)});var o=wp.template("suggest-crop-toolbar");e.$modalToolbar.html(o()),e.bindModal(),e.selectCoordinates()},this.setSelectedCoordinates=function(t,i){e.selectedCoordinates=i},this.setDefaultCoordinates=function(t,i,o,a){var n,d,s={};n=o,d=i*o/t,s.x1=0,s.y1=(a-d)/2,s.x2=n,s.y2=s.y1+d,d>a&&(d=a,n=t*a/i,s.x1=(o-n)/2,s.y1=0,s.x2=s.x1+n,s.y2=d),s.aspectRatio=n+":"+d,e.defaultCoordinates=s},this.compareImages=function(){var t=e.oldImage.width/e.oldImage.height===e.newImage.width/e.newImage.height;t?e.onMatch():e.modalFill()},this.bindModal=function(){t(".imgedit-help-toggle").on("click",function(){t(".imgedit-help").slideToggle()}),e.bindRatio(),e.$primaryButton=e.$modalToolbar.find(".button-primary"),e.$primaryButton.attr("disabled",!1),e.$primaryButton.on("click",function(){e.crop()}),e.$skipButton=e.$primaryButton.siblings(".media-button-skip"),e.$skipButton.on("click",function(){e.modal.close()})},this.bindRatio=function(){var i=e.$modalContent.find('[name="force-aspect-ratio"]');e.$modalContent.find("span#toggle-force").on("click",function(){i.click()}),i.off("change"),i.on("change",function(){t(this).is(":checked")?e.ias.setOptions({aspectRatio:e.defaultCoordinates.aspectRatio,x1:e.defaultCoordinates.x1,y1:e.defaultCoordinates.y1,x2:e.defaultCoordinates.x2,y2:e.defaultCoordinates.y2}):e.ias.setOptions({aspectRatio:!1})})}},BOLDGRID.EDITOR.CropInstance=new BOLDGRID.EDITOR.Crop(jQuery);