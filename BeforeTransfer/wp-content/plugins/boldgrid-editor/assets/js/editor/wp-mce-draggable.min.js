var IMHWPB=IMHWPB||{};IMHWPB.WP_MCE_Draggable=function(){var e=this,t=jQuery;this.resize_selector=".mce-resizehandle",this.draggable_instance=!1;var i=t(window);this.draggable_inactive=!1,this.last_resize=null,this.phone_width_needed=620,this.tablet_width_needed=1250,this.desktop_width_needed=1270,this.bootstrap_container=null;var n=[];this.bind_window_resize=function(){i.on("resize",function(){0==e.draggable_inactive&&(e.last_resize=(new Date).getTime(),setTimeout(e.resize_done_event,250,e.last_resize))})},this.highlight_screen_size=function(i){e.remove_icon_highlights(),t(".mce-boldgrid-"+i).addClass("boldgrid-highlighted-mce-icon")},this.remove_icon_highlights=function(){t(".mce-displaysize-imhwpb").removeClass("boldgrid-highlighted-mce-icon")};var a=t.Event("BoldGridPreInit");this.load_draggable=function(i){0==e.draggable_instance&&(t(document).trigger(a,this),IMHWPB.WP_MCE_Draggable.draggable_instance=i.IMHWPB_Draggable({dragImage:"actual",add_media_event_handler:e.add_media_action,insert_layout_event_handler:e.insert_layout_action,menu_items:n,main_container:!0},t).init(),e.draggable_instance=IMHWPB.WP_MCE_Draggable.draggable_instance),tinymce.activeEditor.controlManager.setActive("toggle_draggable_imhwpb",!0),e.bind_events()},this.add_media_action=function(){e.insert_from_media_modal_tab("insert")},this.insert_from_media_modal_tab=function(t){tinymce.activeEditor.selection.setCursorLocation(e.draggable_instance.$boldgrid_menu_action_clicked,0),wp.media.editor.open(),wp.media.frame.setState(t)},this.insert_layout_action=function(){e.insert_from_media_modal_tab("iframe:insert_layout")},this.set_button_cursor=function(i){if(i.clientX){var n=t(this),a=e.draggable_instance.$master_container.find("button:not([data-mce-bogus])").not(n);e.replace_all_buttons(a),tinymce.activeEditor.selection.setCursorLocation(this,1)}},this.replace_all_buttons=function(e){e.each(function(){var e=this.outerHTML;t(this).replaceWith(e)})},this.bind_events=function(){e.draggable_instance.$master_container.on("mousedown.draggable_mce",".draggable-tools-imhwpb",e.boldgrid_tool_click).on("mouseup.draggable_mce",".draggable-tools-imhwpb",e.boldgrid_tool_click).on("add_column_dwpb.draggable_mce",e.add_column_done).on("drag_start_dwpb.draggable_mce",e.drag_start).on("delete_dwpb.draggable_mce",e.delete_element).on("drag_end_dwpb.draggable_mce",e.drag_end_event).on("add_row_event_dwpb.draggable_mce",e.set_cursor).on("boldgrid_edit_row.draggable_mce",e.edit_row).on("click.draggable_mce","button:not([data-mce-bogus])",e.set_button_cursor).on("click.draggable_mce","a",function(e){e.preventDefault()}).on("resize_start_dwpb.draggable_mce",e.prevent_edit).on("resize_done_dwpb.draggable_mce",e.column_resize_done).on("boldgrid_modify_content.draggable_mce",e.boldgrid_modify_content),e.draggable_instance.$master_container.textSelect(e.text_select_start,e.text_select_end)},this.boldgrid_modify_content=function(){e.refresh_iframe_height()},this.delete_element=function(){e.add_tiny_mce_history(),e.refresh_iframe_height()},this.drag_start=function(){tinymce.activeEditor.getBody().setAttribute("contenteditable",!1),tinyMCE.activeEditor.selection.collapse(!1),e.end_undo_level_mce(),e.draggable_instance.$master_container.find("html").addClass("drag-progress")},this.text_select_start=function(){e.draggable_instance.$master_container.find("html").addClass("selecting")},this.text_select_end=function(){e.draggable_instance.$master_container.find("html").removeClass("selecting")},this.set_cursor=function(e,t){tinymce.activeEditor.selection.setCursorLocation(t,0)},this.prevent_edit=function(){tinyMCE.activeEditor.selection.collapse(!1),e.draggable_instance.ie_version||tinymce.activeEditor.getBody().setAttribute("contenteditable",!1)},this.end_undo_level_mce=function(){IMHWPB.tinymce_undo_disabled=!0},this.drag_end_event=function(t,i){tinymce.activeEditor.getBody().setAttribute("contenteditable",!0),IMHWPB.tinymce_undo_disabled=!1,e.add_tiny_mce_history(),e.initialize_gallery_objects(e.draggable_instance.$master_container),e.draggable_instance.$master_container.find("html").removeClass("drag-progress"),tinymce&&tinymce.activeEditor.selection&&i&&tinymce.activeEditor.selection.setCursorLocation(i,0)},this.column_resize_done=function(){var n;if(!e.draggable_instance.ie_version){tinymce.activeEditor.getBody().blur(),tinymce.activeEditor.getBody().setAttribute("contenteditable",!0);var n=t("<a>temp</a>");t(tinyMCE.activeEditor.getBody()).append(n),tinymce.activeEditor.selection.setCursorLocation(n[0],0),n.focus(),n.remove()}i.trigger("resize")},this.refresh_iframe_height=function(){return},this.add_column_done=function(t,i){e.add_tiny_mce_history(),e.initialize_gallery_objects(e.draggable_instance.$master_container),tinymce.activeEditor.selection.setCursorLocation(i,0)},this.add_tiny_mce_history=function(){tinymce.activeEditor.execCommand("mceAddUndoLevel")},this.initialize_gallery_objects=function(e){"undefined"!=typeof IMHWPBGallery&&"undefined"!=typeof IMHWPBGallery.init_gallery&&(e.find(".masonry").removeClass("masonry"),IMHWPBGallery.init_gallery(e))},this.boldgrid_tool_click=function(){e.remove_mce_resize_handles(),e.draggable_instance.ie_version||(tinyMCE.activeEditor.selection.select(tinyMCE.activeEditor.getBody(),!0),tinyMCE.activeEditor.selection.collapse(!1))},this.remove_mce_resize_handles=function(){e.draggable_instance.$master_container.find("[data-mce-selected]").removeAttr("data-mce-selected"),e.draggable_instance.$master_container.find(".mce-resizehandle").remove(),t(".mce-wp-image-toolbar").hide(),e.draggable_instance.$master_container.find(e.resize_selector).hide()},this.addDeactivateClasses=function(){t("html").addClass("draggable-inactive"),t(tinymce.activeEditor.iframeElement).contents().find("html").addClass("draggable-inactive")},this.toggle_draggable_plugin=function(n){var a=t(tinymce.activeEditor.iframeElement),r=a.contents().get(0);e.draggable_inactive=e.set_style_sheet_inactive("draggable",!e.draggable_inactive,r);var o;"undefined"!=typeof n&&(o=t(n.target)),e.draggable_inactive?(e.remove_icon_highlights(),e.draggable_instance.unbind_all_events(),o&&o.closest("div").removeClass("mce-active"),0==BoldgridEditor.is_boldgrid_theme&&(IMHWPB.Editor.instance.remove_editor_styles(),t('[name="screen_columns"][value="'+IMHWPB.Editor.instance.original_column_val+'"]').click()),e.addDeactivateClasses()):(o&&o.closest("div").addClass("mce-active"),e.draggable_instance.bind_events?(e.draggable_instance.bind_events(),e.bind_events()):e.load_draggable(t(tinymce.activeEditor.iframeElement).contents()),t("html").removeClass("draggable-inactive"),a.contents().find("html").removeClass("draggable-inactive")),e.saveDraggableState(!e.draggable_inactive),i.trigger("resize")},this.saveDraggableState=function(e){t.post(ajaxurl,{action:"boldgrid_draggable_enabled",draggable_enabled:e?1:0,security:BoldgridEditor.draggableEnableNonce})},this.set_style_sheet_inactive=function(e,i,n){"undefined"==typeof n&&(n=document);var a,r=new RegExp(e,"i");return t.each(n.styleSheets,function(e,t){if(t.href&&t.href.match(r))return t.disabled=i,a=t.disabled,!1}),a},this.create_front_page_iframe=function(){if(!BoldgridEditor.is_boldgrid_theme){var n=t('<div class="hidden temp-container">');t.get(BoldgridEditor.site_url,function(a){return n.html(a),t("html").append('<iframe id="resizer-iframe" width="1600" height="600"></iframe>'),e.$resizing_iframe=t("#resizer-iframe"),n.find("script, meta, title").remove(),n.find("img").attr("src",""),n.find("img").attr("srcset",""),n.find("[onload]").removeAttr("onload"),$stripped_without_styles=n.clone(),$stripped_without_styles.find("link, style").remove(),e.$resizing_iframe[0].contentWindow.document.write($stripped_without_styles.html()),$container=e.$resizing_iframe.contents().find('article[class^="post-"]').closest(".container, .container-fluid"),$container.length||($container=e.$resizing_iframe.contents().find('article[class^="post-"] .entry-content > :first-child').closest(".container, .container-fluid")),$container.hasClass("container")?e.bootstrap_container="container":$container.hasClass("container-fluid")&&(e.bootstrap_container="container-fluid"),e.bootstrap_container?(e.$resizing_iframe.remove(),void i.trigger("resize")):(e.$resizing_iframe[0].src=BoldgridEditor.site_url,void(e.$resizing_iframe[0].onload=function(){e.$post_container=e.$resizing_iframe.contents().find('article[class^="post-"]'),i.trigger("resize")}))})}},this.resize_done_event=function(t,i){if(e.last_resize==t||i){var n=e.tinymce_body_container.closest("html"),a=e.tinymce_body_container;if(!e.bootstrap_container&&e.$resizing_iframe){if(!e.$post_container||!e.$post_container.width())return;e.$resizing_iframe.attr("width",n.width()),a.css("width",e.$post_container.width())}IMHWPB.Editor.instance.currently_selected_size?"monitor"==IMHWPB.Editor.instance.currently_selected_size?window.innerWidth>1470?r():window.innerWidth>1355?o():s():"tablet"==IMHWPB.Editor.instance.currently_selected_size?window.innerWidth>1250?r():window.innerWidth>1134?o():s():"phone"==IMHWPB.Editor.instance.currently_selected_size&&r():window.innerWidth>1470?r():window.innerWidth>1355?o():window.innerWidth>1041?s():window.innerWidth<=1040&&e.set_num_columns(2),e.update_device_highlighting(),e.refresh_iframe_height(),e.$window.trigger("resize.boldgrid-gallery")}};var r=function(){e.set_num_columns(2),e.$body.removeClass("folded"),e.$window.trigger("scroll")},o=function(){e.set_num_columns(2),e.$body.addClass("folded"),e.$window.trigger("scroll")},s=function(){e.set_num_columns(1),e.$body.addClass("folded"),e.$window.trigger("scroll")};this.set_num_columns=function(t){1==t?e.$post_body.addClass("columns-1").removeClass("columns-2"):e.$post_body.addClass("columns-2").removeClass("columns-1")},this.update_device_highlighting=function(){if(e.$mce_iframe&&!e.draggable_inactive){var t=e.$mce_iframe.width();t>1061?e.highlight_screen_size("desktop"):t>837?e.highlight_screen_size("tablet"):e.highlight_screen_size("phone")}},this.bind_collapse_click=function(){t("#collapse-menu").on("click",function(){IMHWPB.Editor.instance.currently_selected_size||window.innerWidth>1355&&window.innerWidth<1470&&(e.$body.hasClass("folded")?(e.set_num_columns(2),e.$window.trigger("scroll")):(e.set_num_columns(1),e.$window.trigger("scroll"))),e.update_device_highlighting()})},this.bind_column_switch=function(){t('[name="screen_columns"]').on("click",function(){e.update_device_highlighting()})},this.add_menu_item=function(e,t,i){n.push({title:e,element_type:t,callback:i})},this.edit_row=function(e,i){var n=t(i).find("p, a");n.length&&tinymce.activeEditor.selection.setCursorLocation(n[0],0)},this.bind_min_max_controls=function(){var i=t("#max-row-overlay"),n=t("#min-row-overlay");i.on("click",function(){e.$resize_div.animate({height:"1000px"},1e3)}),n.on("click",function(){e.$resize_div.animate({height:"0px"},1e3)})},this.create_resize_handle=function(){var i=t(".temp-overlay");e.$resize_div.resizable({handles:{n:t(".resizable-n")},start:function(e,t){i.addClass("active")},stop:function(e,t){i.removeClass("active")}}).bind("resize",function(e,i){t(this).css("top","auto")}).removeClass("ui-resizable")},t(function(){e.$window=t(window),e.$body=t("body"),e.$post_body=t("#post-body"),e.$editor_content_container=t("#poststuff"),e.$overlay_preview=t("#boldgrid-overlay-preview"),e.$resize_div=t("#resizable"),e.$mce_iframe=t(tinymce.activeEditor.iframeElement),e.tinymce_body_container=e.$mce_iframe.contents().find("body"),e.bind_column_switch(),e.create_front_page_iframe(),e.bind_window_resize(),e.bind_collapse_click(),e.bind_min_max_controls(),e.create_resize_handle()})};